<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.2/awesomplete.css" />

    <link rel="stylesheet" href="axial.css" />

    <style type="text/css">
        .tooltip {
            position: absolute;
            z-index: 10;
            background-color: #000;
            color: #fff;
            padding: 2px 7px;
            visibility: hidden;
            opacity: 0.75;
            border-radius: 3px;
        }

        .tooltip::after {
            content: " ";
            position: absolute;
            top: 14%;
            right: 100%; /* To the left of the tooltip */
            margin-top: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent #000 transparent transparent;
        }

    </style>

    <title>ABCD1-knockout transcriptome</title>

</head>
<body>


    <div class="container-fluid">

        <div class="row flex-nowrap">
            <div class="col-md-4 col-12 menu">
                <div class="card">
                    <div class="card-header">
                        <a class="pull-right" role="button"><i class="fa" id="hide-show"></i></a>
                        <h1><a href="index.html" class="link-unstyled">ABCD1-knockout transcriptome</a></h1>
                        <p><a id="enrich" href="#">Enrich DE genes</a> | <a id="degenes" href="#">Download DE genes</a> | <a id="download">Download SVG</a></p>

                        <nav>
                            <div class="nav nav-tabs card-header-tabs" role="tablist">
                                <a class="nav-item nav-link active">hBMEC</a>
                                <a class="nav-item nav-link" href="mouse_volcano.html">mBMEC</a>
                                <a class="nav-item nav-link" href="lee_volcano.html">Lee et. al. 2018 iPS</a>
                            </div>
                        </nav>

                    </div>
                    <div class="tab-content collapse show" id="collapsable">
                        <div class="tab-pane fade show active card-body" id="hBMEC" role="tabpanel">

                            <label for="point_size">Point Size</label>
                            <input type="range" id="point_size" name="" min="0.5" max="4" step="0.1" value="2.0" style="position: relative; top: 3px;">
                            <br>
                            Colors:
                            <input type="color" value="#cccccc" id="bad_logFC_bad_q_color_picker">
                            <input type="color" value="#ee8822" id="good_logFC_bad_q_color_picker">
                            <input type="color" value="#eecc22" id="bad_logFC_good_q_color_picker">
                            <input type="color" value="#ee2222" id="good_logFC_good_q_color_picker">
                            <input type="color" value="#ff0000" id="threshold_color">

                            <hr>
                            <input type="checkbox" id="show_text" name="show_text" value="show_text">
                            <label for="show_text">Show Gene Symbols</label>
                            <br>
                            <label for="font_size">Font Size</label>
                            <input type="range" id="font_size" name="" min="1" max="16" step="0.1" value="6" style="position: relative; top: 3px;" disabled>

                            <hr>
                            <input class="form-control" id="chooseGene" placeholder="Search for a gene" />

                        </div>
                    </div>
                </div>
            </div>

            <div id="graph-container" class="col-md col-12"></div>

        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>

    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.2/awesomplete.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>

    <script type="text/javascript" src="data/human_differential.js"></script>
    <script type="text/javascript" src="volcano.js"></script>

    <script type="text/javascript">


/////////////////////////////////////////////////////////////////////////////
                 ///////    Figure Styling    ///////
/////////////////////////////////////////////////////////////////////////////

$('#hide-show').click(function(e) { $('.menu').toggleClass('hidden'); });


$("#bad_logFC_bad_q_color_picker").change(function() {
    bad_logFC_bad_q_color = this.value;
    restart();
});
$("#good_logFC_bad_q_color_picker").change(function() {
    good_logFC_bad_q_color = this.value;
    restart();
});
$("#bad_logFC_good_q_color_picker").change(function() {
    bad_logFC_good_q_color = this.value;
    restart();
});
$("#good_logFC_good_q_color_picker").change(function() {
    good_logFC_good_q_color = this.value;
    restart();
});
$("#threshold_color").change(function() {
    threshold_color = this.value;
    threshold.attr("stroke", threshold_color);
});

$("#point_size").change(function() {
    point_size = parseFloat(this.value);
    restart();
});

$("#show_text").change(function() {
    show_text = this.checked;
    if (show_text) { $("#font_size").prop('disabled', false); }
    else {           $("#font_size").prop('disabled', true); }
    restart();
});

$("#font_size").change(function() {
    font_size = parseFloat(this.value);
    text.style("font-size", font_size);
});


/////////////////////////////////////////////////////////////////////////////
                 ///////    Find a Gene    ///////
/////////////////////////////////////////////////////////////////////////////


var input = document.getElementById("chooseGene");
var form = new Awesomplete(input, {
    list: _(data).pluck('id'),
    maxItems: 30,
});
document.addEventListener('awesomplete-selectcomplete', function(e) {
    element = d3.select('#'+e.text.value)
    selected_gene = element._groups[0][0].__data__;
    position = element.node().getBoundingClientRect();
    tipEnter(selected_gene);
    tooltip.style("top", (position.y - 5) + "px")
           .style("left", (position.x + 10) + "px");

});

/////////////////////////////////////////////////////////////////////////////
                 ///////    Enrichr / GOrilla   ///////
/////////////////////////////////////////////////////////////////////////////


$("#enrich").click(function(e) {
    var genes = _(data.filter(is_differential)).pluck('id');

    // ENRICHR
    // var description  = description || "";
    // var popup = true;
    // var form = document.createElement('form');
    // var listField = document.createElement('input');
    // var descField = document.createElement('input');
    // form.setAttribute('method', 'post');
    // form.setAttribute('action', 'http://amp.pharm.mssm.edu/Enrichr/enrich');
    // form.setAttribute('target', '_blank');
    // form.setAttribute('enctype', 'multipart/form-data');
    // listField.setAttribute('type', 'hidden');
    // listField.setAttribute('name', 'list');
    // listField.setAttribute('value', genes);
    // form.appendChild(listField);
    // descField.setAttribute('type', 'hidden');
    // descField.setAttribute('name', 'description');
    // descField.setAttribute('value', description);
    // form.appendChild(descField);

    // GOrilla
    var form = document.createElement('form');
    form.setAttribute('method', 'post');
    form.setAttribute('action', 'http://cbl-gorilla.cs.technion.ac.il/servlet/GOrilla');
    form.setAttribute('target', '_blank');
    form.setAttribute('enctype', 'multipart/form-data');

    var application_field = document.createElement('input');
    application_field.setAttribute("type", "hidden");
    application_field.setAttribute("name", "application");
    application_field.setAttribute("value", "gorilla");
    form.appendChild(application_field);

    var species_field = document.createElement('input');
    species_field.setAttribute("type", "hidden");
    species_field.setAttribute("name", "species");
    species_field.setAttribute("value", "HOMO_SAPIENS");
    form.appendChild(species_field);

    var run_mode_field = document.createElement('input');
    run_mode_field.setAttribute("type", "hidden");
    run_mode_field.setAttribute("name", "run_mode");
    run_mode_field.setAttribute("value", "mhg");
    form.appendChild(run_mode_field);

    var target_set_field = document.createElement('input');
    target_set_field.setAttribute("type", "hidden");
    target_set_field.setAttribute("name", "target_set");
    target_set_field.setAttribute("value", genes.join("\n"));
    form.appendChild(target_set_field);

    var background_set_field = document.createElement('input');
    background_set_field.setAttribute("type", "hidden");
    background_set_field.setAttribute("name", "background_set");
    background_set_field.setAttribute("value", "");
    form.appendChild(background_set_field);

    var db_field = document.createElement('input');
    db_field.setAttribute("type", "hidden");
    db_field.setAttribute("name", "db");
    db_field.setAttribute("value", "proc");
    form.appendChild(db_field);

    var run_gogo_button_field = document.createElement('input');
    run_gogo_button_field.setAttribute("type", "hidden");
    run_gogo_button_field.setAttribute("name", "run_gogo_button");
    run_gogo_button_field.setAttribute("value", "Search Enriched GO terms");
    form.appendChild(run_gogo_button_field);

    var pvalue_thresh_field = document.createElement('input');
    pvalue_thresh_field.setAttribute("type", "hidden");
    pvalue_thresh_field.setAttribute("name", "pvalue_thresh");
    pvalue_thresh_field.setAttribute("value", "0.001");
    form.appendChild(pvalue_thresh_field);

    var analysis_name_field = document.createElement('input');
    analysis_name_field.setAttribute("type", "hidden");
    analysis_name_field.setAttribute("name", "analysis_name");
    analysis_name_field.setAttribute("value", "");
    form.appendChild(analysis_name_field);

    var user_email_field = document.createElement('input');
    user_email_field.setAttribute("type", "hidden");
    user_email_field.setAttribute("name", "user_email");
    user_email_field.setAttribute("value", "");
    form.appendChild(user_email_field);

    var fast_mode_field = document.createElement('input');
    fast_mode_field.setAttribute("type", "hidden");
    fast_mode_field.setAttribute("name", "fast_mode");
    fast_mode_field.setAttribute("value", "on");
    form.appendChild(fast_mode_field);

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

});

/////////////////////////////////////////////////////////////////////////////
                 ///////    Downloads    ///////
/////////////////////////////////////////////////////////////////////////////

d3.select("#download").on("click", function() {

    d3.select(this)
      .attr("href", 'data:application/octet-stream;base64,' + btoa(unescape(encodeURIComponent(d3.select("#graph-container").html()))))
      .attr("download", "plot.svg")
})

$("#degenes").click(function() {

    d3.select(this)
      .attr("href", 'data:application/octet-stream;base64,' + btoa(_(data.filter(is_differential)).pluck('id').join("\n")))
      .attr("download", "DE_Genes.txt")
})

    </script>

</body>

</html>
